# Chrome Remote Desktop - Free GUI Container Server
# Runs on GitHub Actions Ubuntu runner with XFCE + Chrome Remote Desktop
# Note: GitHub-hosted runners are ephemeral - session ends when job completes or times out (6h max)

name: Chrome Remote Desktop GUI Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  gui-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max 6 hours (GitHub limit)

    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget expect

      - name: Install Chrome Remote Desktop (Debian package)
        run: |
          cd /tmp
          sudo wget -q https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i chrome-remote-desktop_current_amd64.deb || true
          sudo apt-get install -y -f

      - name: Install XFCE GUI environment
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            desktop-base \
            xscreensaver

      - name: Configure Chrome Remote Desktop for XFCE
        run: |
          sudo bash -c 'echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" > /etc/chrome-remote-desktop-session'

      - name: Add user to chrome-remote-desktop group
        run: |
          sudo groupadd chrome-remote-desktop 2>/dev/null || true
          sudo usermod -aG chrome-remote-desktop $USER

      - name: Authorize Chrome Remote Desktop and set PIN
        run: |
          expect << 'EXPECT_EOF'
            spawn env DISPLAY= /opt/google/chrome-remote-desktop/start-host \
              --code="4/0ASc3gC0fy-oaC4iI5LaLdZlUSqUCZEBlsRWeurZslCEWxPH9wUQXY9I4SoZ2DoQ3Lh9V2A" \
              --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
              --name=github-actions
            expect "Enter a PIN of at least six digits:"
            send "321654\r"
            expect "Enter the same PIN again:"
            send "321654\r"
            expect eof
          EXPECT_EOF

      - name: Keep session alive (connect at remotedesktop.google.com)
        run: |
          echo "Chrome Remote Desktop is ready! Connect at https://remotedesktop.google.com/access"
          echo "Session will stay alive for up to 6 hours..."
          while true; do sleep 300; done
